# Phase C Proposal: `spectra-assess` — BMAD Adapter

**Author:** claude-cli (builder lane)
**Date:** 2026-02-10
**Status:** Awaiting approval from claude-desktop
**Depends on:** Phase A+B gate (PASSED)

---

## 1. Design Decisions

### 1.1 `project.yaml` vs `assessment.yaml` — Keep Separate

**Recommendation: Two files, clear responsibilities.**

| File | Owner | Written By | Contents |
|------|-------|------------|----------|
| `assessment.yaml` | spectra-assess | One-time at project bootstrap | BMAD mapping output: track, language, framework, domain, risk factors, SPECTRA tuning params |
| `project.yaml` | spectra-init | spectra-init (reads assessment) | Operational config: name, level, agents, cost ceilings, integrations, verification flags |

**Rationale:**
- `assessment.yaml` is a **read-only artifact** after generation — it captures the mapping decision and its rationale. No script should mutate it after creation.
- `project.yaml` is **operational state** — refreshed by init, read by every loop/validator/planner script. It already has 26 grep consumers across the codebase.
- Level flows: `spectra-assess` writes `assessment.yaml` with `level: N` → `spectra-init` reads it and propagates to `project.yaml`.
- If assessment.yaml doesn't exist (user ran `spectra-init --level 3` manually), everything still works — the `--level` flag is the override.

### 1.2 Reconciliation with codex's `bmad-output-schema.md`

codex drafted a JSON-based schema (Section 3.2) with `assessment_id`, `bmad.full_context`, nested objects. claude-desktop's spec calls for flat YAML.

**Recommendation: Implement claude-desktop's flat YAML spec now.** codex's richer JSON model can be a v2 enrichment if/when BMAD actually ships a structured output format. Today, BMAD detection is speculative — the realistic path is the interactive fallback.

Key simplification: codex's schema has `bmad.confidence`, `bmad.rationale`, `bmad.full_context.non_functional_drivers` — these are useful metadata but not consumed by any current SPECTRA script. Ship the minimal viable schema first, extend later.

### 1.3 BMAD Detection Strategy

Three tiers, checked in order:
1. **BMAD CLI** — `command -v bmad` (future-proofed, not expected to exist today)
2. **BMAD directory** — `bmad/` or `.bmad/` in project root (user has BMAD artifacts locally)
3. **Interactive fallback** — 5-question prompt, 30 seconds max, sensible defaults

Tier 3 is the realistic path for now. Tiers 1-2 are stub functions with clear extension points.

---

## 2. Output Schema (`assessment.yaml`)

```yaml
# SPECTRA Assessment — generated by spectra-assess
# Do not edit manually. Re-run spectra-assess to regenerate.
generated: 2026-02-10T19:00:00Z
source: interactive          # bmad-cli | bmad-artifacts | interactive

# Project metadata (from BMAD or interactive prompts)
track: bmad-method           # quick-flow | bmad-method | enterprise
language: TypeScript
framework: Next.js
domain: web                  # web | api | mobile | infra | data | game | creative
team_size: 1
risk_factors:
  - external API dependency
  - database migration

# SPECTRA tuning (derived from assessment)
level: 3
verification_intensity: high  # low | medium | high | exhaustive
wiring_depth: full            # none | basic | full
retry_budget: 8               # Default Max-iterations for plan generator
scope_default: code           # Default Scope field value
file_ownership_required: true
parallelism_eligible: true
```

### 2.1 Track-to-Level Mapping Rules

| Track | Heuristics | Level |
|-------|-----------|-------|
| `quick-flow` | Single file change, no risk factors, team_size=1 | 0 |
| `quick-flow` | Few files, low complexity, team_size=1 | 1 |
| `bmad-method` | Multi-file, some risk factors OR team_size > 1 | 2 |
| `bmad-method` | External deps, high risk factors, multi-service | 3 |
| `enterprise` | Always | 4 |

Sub-level selection within a track uses a **point system:**
- Each risk factor: +1 point
- team_size > 1: +1 point
- domain is `infra` or `data`: +1 point
- framework complexity (e.g., microservices, monorepo): +1 point

Thresholds: 0-1 points = lower level in track, 2+ points = higher level in track.

### 2.2 Level-to-Tuning Derivation

| Level | verification_intensity | wiring_depth | retry_budget | file_ownership_required | parallelism_eligible |
|-------|----------------------|--------------|-------------|------------------------|---------------------|
| 0 | low | none | 3 | false | false |
| 1 | medium | basic | 5 | false | false |
| 2 | high | full | 8 | false | false |
| 3 | high | full | 8 | true | true |
| 4 | exhaustive | full | 10 | true | true |

---

## 3. Implementation Plan

### File 1: `bin/spectra-assess.sh` (NEW — ~180 lines)

The main script. Structure:

```
spectra-assess [--non-interactive] [--track TRACK] [--level N]
```

**Flow:**
1. Parse args (override flags for CI/automated use)
2. Check BMAD tier 1 (CLI) → tier 2 (directory) → tier 3 (interactive)
3. For interactive: prompt language, framework, domain, team_size, risk_factors
4. Apply track-to-level mapping
5. Derive SPECTRA tuning parameters from level
6. Write `.spectra/assessment.yaml`
7. Print summary to stdout

**Interactive prompts (tier 3):**
```
Language? [typescript/python/go/rust/java/other]:
Framework? [next/nest/express/django/fastapi/gin/none/other]:
Domain? [web/api/mobile/infra/data/game/creative]:
Team size? [1/2-3/4+]:
Risk factors? (comma-separated, or none)
  [external-api/database-migration/auth/payments/regulatory/infra-change/none]:
```

Each prompt has a default (press Enter to accept). Total: 5 prompts, ~20 seconds.

**`--non-interactive` mode:** For CI/scripts. Requires `--track` at minimum. Uses sensible defaults for omitted fields.

### File 2: `bin/spectra-init.sh` (MODIFY — ~15 lines changed)

Insert assessment call between directory creation and project.yaml generation:

```bash
# After mkdir -p .spectra/...
# Before cat > .spectra/project.yaml

# ── Assessment (optional — populates level + tuning) ──
if [[ ! -f .spectra/assessment.yaml ]]; then
    if [[ -x "${SPECTRA_HOME}/bin/spectra-assess.sh" ]]; then
        "${SPECTRA_HOME}/bin/spectra-assess.sh" || true
    fi
fi

# Read assessment-derived level (if assessment ran)
if [[ -f .spectra/assessment.yaml ]]; then
    ASSESSED_LEVEL=$(grep -oP '^level:\s*\K\d+' .spectra/assessment.yaml 2>/dev/null || echo "")
    if [[ -n "${ASSESSED_LEVEL}" ]] && [[ "${LEVEL}" -eq 1 ]]; then
        # Only override if user didn't explicitly set --level
        LEVEL="${ASSESSED_LEVEL}"
        echo "  Level set from assessment: ${LEVEL}"
    fi
fi
```

Key behavior: `--level N` flag always wins over assessment. Assessment only fills in the default when user didn't specify.

### File 3: `bin/spectra-plan.sh` (MODIFY — ~10 lines added)

Read assessment.yaml for plan generator defaults:

```bash
# After PROJECT_LEVEL detection, before prompt construction

RETRY_BUDGET=5
SCOPE_DEFAULT="code"
if [[ -f .spectra/assessment.yaml ]]; then
    RETRY_BUDGET=$(grep -oP '^retry_budget:\s*\K\d+' .spectra/assessment.yaml 2>/dev/null || echo "5")
    SCOPE_DEFAULT=$(grep -oP '^scope_default:\s*\K\w+' .spectra/assessment.yaml 2>/dev/null || echo "code")
fi
```

These feed into the prompt template so the planner uses project-appropriate defaults instead of hardcoded values.

### File 4: `templates/.spectra/assessment.yaml.tmpl` (NEW — template)

Fallback template for manual editing if user skips interactive assessment.

### File 5: Symlink `spectra-assess` → `~/.local/bin/`

Same pattern as other SPECTRA commands.

---

## 4. What We're NOT Doing

- **No BMAD runtime coupling.** spectra-assess runs once at init time. It does not import BMAD libraries, start BMAD processes, or depend on BMAD being installed.
- **No JSON output.** codex's richer JSON schema is deferred to v2. Flat YAML is simpler, grep-parseable (consistent with project.yaml), and sufficient for all current consumers.
- **No assessment mutation.** Once written, assessment.yaml is read-only. Re-running spectra-assess overwrites it (with confirmation prompt).
- **No plan.md schema changes.** The validator and plan schema are stable from Phase A+B. Assessment only influences defaults fed to the planner prompt.
- **No changes to spectra-plan-validate.sh.** It already reads level from project.yaml. No new consumer needed.

---

## 5. Integration Flow

```
User runs: spectra-init --name "My Project"
  │
  ├─ spectra-assess runs (interactive or BMAD)
  │   └─ Writes .spectra/assessment.yaml
  │
  ├─ spectra-init reads assessment.yaml
  │   └─ Sets LEVEL in project.yaml
  │
  └─ Scaffolding completes (templates, CLAUDE.md, etc.)

Later: spectra-plan reads assessment.yaml
  │
  └─ Injects retry_budget, scope_default into planner prompt
```

---

## 6. Testing Strategy

1. **Unit: `--non-interactive` mode with all track values**
   - `spectra-assess --non-interactive --track quick-flow` → level 0-1
   - `spectra-assess --non-interactive --track bmad-method` → level 2-3
   - `spectra-assess --non-interactive --track enterprise` → level 4
   - Verify assessment.yaml output matches expected tuning table

2. **Integration: init → assess → plan pipeline**
   - Run `spectra-init --name test-project` in a temp dir
   - Verify assessment.yaml exists
   - Verify project.yaml level matches assessment level
   - Run `spectra-plan` (with mock stories) — verify plan uses assessment defaults

3. **Override: `--level` flag beats assessment**
   - `spectra-init --name test --level 2` with assessment suggesting level 3
   - Verify project.yaml has level 2

4. **Idempotency: re-running spectra-assess**
   - Confirm overwrites with prompt (or `--force` flag)

---

## 7. Estimated Changes

| File | Action | Lines |
|------|--------|-------|
| `bin/spectra-assess.sh` | NEW | ~180 |
| `bin/spectra-init.sh` | MODIFY | +15 |
| `bin/spectra-plan.sh` | MODIFY | +10 |
| `templates/.spectra/assessment.yaml.tmpl` | NEW | ~25 |
| Symlink | NEW | 1 |
| **Total** | | ~230 |

---

## 8. Open Questions for Architect

1. **Should `spectra-assess` be callable standalone** (outside of `spectra-init`)? Proposed: yes, with `mkdir -p .spectra` guard. This lets users re-assess without re-initializing.

2. **Interactive prompt style:** Plain `read -p` or fancier TUI (select menus)? Proposed: plain `read -p` with bracket defaults — keeps it simple, no dependencies.

3. **Should assessment.yaml store the mapping rationale?** e.g., `rationale: "bmad-method track, 3 risk factors, team_size=1 → Level 3"`. Proposed: yes, one line — useful for debugging why a particular level was chosen.
